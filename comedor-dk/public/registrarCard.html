<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Registrar Tarjeta - Comedor</title>
    <link rel="stylesheet" href="assets/css/theme.css" />
    <style>
      body {
        font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
        padding: 24px;
        background: #fff;
        color: #111;
      }
      .wrap {
        max-width: 640px;
        margin: 0 auto;
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: 700;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e6e6e6;
        margin-top: 6px;
      }
      .row {
        display: flex;
        gap: 12px;
      }
      .actions {
        margin-top: 16px;
        display: flex;
        gap: 8px;
      }
      /* Buttons styled similar to keypad */
      button {
        padding: 12px 16px;
        border-radius: 14px;
        border: 1px solid #f0dede;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.04);
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1 id="title">Registrar tarjeta</h1>

      <form id="form">
        <label for="nombre">Nombre completo</label>
        <input id="nombre" name="nombre" required />

        <label for="tipo">Tipo</label>
        <select id="tipo" name="tipo">
          <option value="normal">Normal</option>
          <option value="administracion">Administracion</option>
          <option value="Visitantes">Visitantes</option>
        </select>

        <label for="code"
          >Código (5 dígitos) — dejar vacío para generar automático</label
        >
        <input
          id="code"
          name="code"
          placeholder="Ej: 01234 (se genera si se deja vacío)"
          maxlength="5"
        />

        <label for="code_rfc">Código tarjeta (code_rfc) — opcional</label>
        <input
          id="code_rfc"
          name="code_rfc"
          placeholder="Código físico (tarjeta/lector)"
        />

        <div class="actions">
          <button type="submit">Guardar</button>
          <button type="button" id="btnCancel">Cancelar</button>
        </div>
      </form>
    </div>

    <script>
      const q = new URLSearchParams(location.search);
      const id = q.get("id");
      const title = document.getElementById("title");
      const form = document.getElementById("form");

      if (id) {
        title.textContent = "Editar tarjeta";
        // load data
        fetch(`/api/cards/${id}`)
          .then((r) => {
            if (!r.ok) throw new Error();
            return r.json();
          })
          .then((js) => {
            document.getElementById("nombre").value = js.nombre || "";
            document.getElementById("tipo").value = js.tipo || "normal";
            document.getElementById("code").value = js.code || "";
            document.getElementById("code_rfc").value = js.code_rfc || "";
          })
          .catch(() => alert("No se pudo cargar el registro"));
      }

      document
        .getElementById("btnCancel")
        .addEventListener("click", () => (location.href = "listarCard.html"));

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nombre = document.getElementById("nombre").value.trim();
        const tipo = document.getElementById("tipo").value;
        const code = document.getElementById("code").value.trim();
        const code_rfc = document.getElementById("code_rfc").value.trim();
        if (!nombre) {
          alert("El nombre es requerido");
          return;
        }

        try {
          let res;
          if (id) {
            res = await fetch(`/api/cards/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ nombre, tipo, code, code_rfc }),
            });
          } else {
            res = await fetch("/api/cards", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ nombre, tipo, code, code_rfc }),
            });
          }
          if (!res.ok) {
            const b = await res.json().catch(() => ({}));
            alert(b.msg || "Error");
            return;
          }
          // success
          location.href = "listarCard.html";
        } catch (err) {
          alert("Error de red");
        }
      });
    </script>
  </body>
</html>
