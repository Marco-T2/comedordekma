<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Menu - Comedor</title>
    <link rel="stylesheet" href="assets/css/theme.css" />
    <style>
      :root {
        --accent: var(--COLOR-2, #f7e6e3);
      }
      body {
        font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
        padding: 34px;
        background: var(--bg, #fff);
        color: var(--text, #111);
        font-size: 25px;
      }
      .container {
        max-width: 1300px;
        margin: 0 auto;
        padding: 6px 18px;
      }
      .header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 18px;
      }
      .header-left,
      .header-center,
      .header-right {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* asegurar fecha a la derecha */
      }
      .header-left,
      .header-center {
        display: flex;
        align-items: center;
      }
      .header-center {
        flex-direction: column;
        justify-content: center;
      }
      .tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 14px 0 18px;
        justify-content: flex-start;
      }
      .tab {
        padding: 14px 22px;
        min-width: 140px;
        text-align: center;
        border: 1px solid #f4d8d7;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        background: #fff6f6;
        cursor: pointer;
        font-weight: 800;
        color: #333;
        font-size: 22px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
      }
      .tab[aria-selected="true"] {
        background: #ff6b65;
        color: #fff;
        border-color: #ff6b65;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
      }
      .panel {
        border: 1px solid #e6e6e6;
        border-radius: 14px;
        padding: 26px;
        background: #fff;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.05);
      }
      .panel .card {
        background: var(--accent);
        border-radius: 14px;
        padding: 26px;
        margin: 8px 0 18px;
        font-size: 18px;
      }
      .panel h2 {
        margin: 0 0 12px;
        font-size: 22px;
      }
      .panel ul {
        margin: 0 0 8px 20px;
        line-height: 1.6;
      }
      .panel .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 18px;
      }
      .btn {
        padding: 12px 18px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: var(--accent, #ff6b65);
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      }
      .btn.primary {
        background: #ff6b65;
        color: #fff;
        border-color: #ff6b65;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      }
      .btn.secondary {
        background: #fff;
        color: #111;
        border: 1px solid #eee;
        box-shadow: none;
      }
      .no-menus {
        padding: 18px;
        border: 1px dashed #e6e6e6;
        border-radius: 12px;
        background: #fff;
        color: #666;
      }

      /* confirm modal */
      .confirm-overlay {
        position: fixed;
        inset: 0;
        z-index: 1200;
        display: grid;
        place-items: center;
        padding: 24px;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(2px);
      }
      .confirm-box {
        background: #fff;
        border-radius: 14px;
        padding: 24px;
        width: min(1000px, 100%);
        box-shadow: 0 24px 70px rgba(0, 0, 0, 0.35);
        display: grid;
        grid-template-columns: 1fr 240px;
        gap: 24px;
        align-items: start;
        animation: pop 0.16s ease-out;
      }
      @keyframes pop {
        from {
          transform: scale(0.98);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .confirm-left {
        display: flex;
        flex-direction: column;
      }
      .receipt {
        border: 1px solid #e6e6e6;
        padding: 16px;
        border-radius: 8px;
        background: #fff;
      }
      .receipt h3 {
        margin: 0 0 8px;
        font-size: 20px;
      }
      .receipt .code {
        font-weight: 900;
        font-size: 20px;
        margin-bottom: 8px;
      }
      .receipt ul {
        margin: 8px 0 12px 18px;
      }
      .receipt .auth {
        margin-top: 10px;
        font-weight: 700;
      }
      .confirm-right {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        justify-content: space-between;
        min-height: 220px;
      }
      .confirm-close {
        position: absolute;
        top: 10px;
        right: 12px;
        border: 0;
        background: transparent;
        font-size: 22px;
        cursor: pointer;
        line-height: 1;
        color: #777;
      }
      .confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 12px;
      }
      .printer-ico {
        width: 140px;
        height: 140px;
        border-radius: 12px;
        border: 1px dashed #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 56px;
      }
      .printer-ico.lg {
        width: 180px;
        height: 180px;
        font-size: 72px;
      }

      /* TICKET styles (printer-like) */
      .ticket-wrap {
        display: block;
        margin-top: 12px;
      }
      .ticket {
        width: 100%;
        max-width: none;
        border: 3px solid #111;
        border-radius: 6px;
        /* aumentar tama√±o base de fuente para que el PNG tenga texto m√°s legible */
        font: 24px/1.35 "Inter", system-ui, Arial;
        color: #111;
        background: #fff;
        position: relative;
        padding: 8px;
      }
      .t-row {
        display: flex;
        align-items: stretch;
      }
      .t-col {
        padding: 10px 12px;
      }
      .t-b {
        border-bottom: 3px solid #111;
      }
      .t-r {
        border-right: 3px solid #111;
      }
      .t-l {
        border-left: 3px solid #111;
      }
      .t-code {
        flex: 1;
        font-weight: 900;
        /* reducir el tama√±o del PED en la parte superior */
        font-size: 40px;
        letter-spacing: 1px;
      }
      .t-type {
        width: 180px;
        font-weight: 900;
        /* reducir ligeramente el tipo en la parte superior */
        font-size: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      /* nuevo layout: checks en columna a la derecha, centrados verticalmente */
      .t-body {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .t-items {
        flex: 1;
      }
      .t-checks {
        width: 180px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding-left: 8px;
        align-items: flex-start;
        justify-content: center;
        box-sizing: border-box;
        /* aumentar tama√±o de labels de check en la parte inferior */
        font-size: 24px;
      }
      .chk {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 6px 0;
        font-weight: 700;
      }
      .box {
        width: 20px;
        height: 20px;
        border: 3px solid #111;
        display: inline-block;
      }
      .box.on {
        background: #111;
      }
      .lab {
        width: 56px;
        font-weight: 700;
      }
      .t-items {
        min-height: 140px;
      }
      .t-items ul {
        margin: 0 0 0 20px;
        padding: 0;
      }
      .t-items li {
        margin: 8px 0;
        /* aumentar tama√±o de items para la parte inferior */
        font-size: 26px;
      }
      .t-auth {
        font-weight: 900;
        /* auth m√°s grande */
        font-size: 28px;
      }

      /* actions column tweaks */
      .confirm-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }
      .confirm-actions .btn {
        width: 100%;
      }
      .btn-print {
        width: 100%;
        padding: 12px 18px;
        border: 1px solid #ff6b65;
        border-radius: 10px;
        cursor: pointer;
        background: #ff6b65;
        color: #fff;
        font-weight: 800;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      }
      .btn-print:hover {
        filter: brightness(0.96);
      }

      @media print {
        @page {
          size: 80mm auto;
          margin: 4mm;
        }
        body {
          background: #fff;
        }
        * {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        .container,
        .header,
        .confirm-right,
        .btn-print {
          display: none !important;
        }
        .confirm-overlay {
          position: static;
          padding: 0;
          background: transparent;
        }
        .confirm-box {
          box-shadow: none;
          padding: 0;
          width: auto;
          grid-template-columns: 1fr;
        }
        .ticket {
          width: 78mm;
          border-width: 2px;
          /* mayor tama√±o para impresi√≥n */
          font-size: 24px;
          padding: 8px;
        }
        .t-code {
          font-size: 42px;
        }
        .t-type {
          font-size: 28px;
        }
        .t-items li {
          font-size: 26px;
        }
        .t-checks {
          font-size: 24px;
        }
        .confirm-box {
          grid-template-columns: 1fr;
        }
        .confirm-right {
          width: 100%;
        }
      }
      body.modal-open {
        overflow: hidden;
      }
      @media (max-width: 720px) {
        .tabs {
          gap: 6px;
        }
        .tab {
          padding: 8px 10px;
          font-size: 20px;
          min-width: 80px;
        }
        .btn {
          padding: 10px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-left">
          <div
            id="usuario"
            class="user"
            style="
              font-weight: 700;
              color: #333;
              font-size: 18px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <span id="usuario-icon">üë§</span>
            <span id="usuario-text">Comensal (0003322164)</span>
          </div>
        </div>
        <div class="header-center">
          <img
            src="assets/images/logo-dekma.png"
            alt="Dekma"
            style="height: 44px"
            onerror="this.style.display='none'"
          />
          <strong style="font-size: 34px; letter-spacing: 2px; margin-top: 6px"
            >MENU</strong
          >
        </div>
        <div class="header-right">
          <div id="fecha">&nbsp;</div>
        </div>
      </div>

      <div id="menuRoot">
        <div
          class="tabs"
          id="tabs"
          role="tablist"
          aria-label="Men√∫ del d√≠a"
        ></div>
        <div class="panel" id="panel" role="tabpanel" tabindex="0"></div>
      </div>
    </div>

    <script>
      // Mock data fallback (tabs requested by user)
      const mockTabs = [
        { id: 1, tipo_menu: "Desayuno", estado: 1 },
        { id: 2, tipo_menu: "Almuerzo", estado: 1 },
        { id: 3, tipo_menu: "Almuerzo-Especial", estado: 1 },
        { id: 4, tipo_menu: "Te", estado: 1 },
        { id: 5, tipo_menu: "Cena", estado: 1 },
        { id: 6, tipo_menu: "Trasnoche", estado: 1 },
      ];
      const mockItems = {
        Desayuno: ["Api de quinua", "Tostadas con queso", "T√© con hierbas"],
        Almuerzo: ["Sopa de man√≠", "Pique macho", "Refresco de linaza"],
        "Almuerzo-Especial": [
          "Ensalada templada",
          "Segunda opci√≥n: pollo",
          "Jugo natural",
        ],
        Te: ["Bizcocho", "Mermelada", "T√© negro"],
        Cena: ["Caldito de pollo", "Arroz con queso", "Mate de manzanilla"],
        Trasnoche: ["Bebida caliente", "Tostadas", "Sopa ligera"],
      };

      async function getTabs() {
        try {
          const r = await fetch("/api/menu/tabs");
          if (r.ok) return r.json();
        } catch (e) {}
        return mockTabs;
      }

      async function getItems(tipo) {
        try {
          const r = await fetch(
            "/api/menu/items?tipo=" + encodeURIComponent(tipo)
          );
          if (r.ok) return r.json();
        } catch (e) {}
        return mockItems[tipo] || [];
      }

      document.getElementById("fecha").textContent =
        new Date().toLocaleDateString();
      // fecha estilo m√°s grande
      const f = document.getElementById("fecha");
      if (f) {
        f.style.fontSize = "25px";
        f.style.fontWeight = "700";
      }

      // populate user from querystring (optional)
      (function populateUser() {
        try {
          const qp = new URLSearchParams(location.search);
          const nombre = qp.get("nombre") || "Comensal";
          const card = qp.get("card") || "0003322164";
          const tipo = qp.get("tipo") || "";
          const uText = document.getElementById("usuario-text");
          const uIcon = document.getElementById("usuario-icon");
          if (uText)
            uText.textContent = `${nombre}${card ? ` (${card})` : ""}${
              tipo ? ` ‚Äì ${tipo}` : ""
            }`;
          if (uIcon) uIcon.textContent = "üë§";
        } catch (e) {
          /* ignore */
        }
      })();

      (async function init() {
        const raw = await getTabs();
        const tabsData = (raw || [])
          .filter((t) => Number(t.estado) === 1)
          .sort((a, b) => a.id - b.id);
        const tabsEl = document.getElementById("tabs");
        const panelEl = document.getElementById("panel");
        if (!tabsData || tabsData.length === 0) {
          tabsEl.innerHTML = "";
          panelEl.innerHTML =
            '<div class="no-menus">No hay men√∫s habilitados hoy.</div>';
          return;
        }
        let current = tabsData[0];

        function renderTabs() {
          tabsEl.innerHTML = "";
          tabsData.forEach((t) => {
            const b = document.createElement("button");
            b.className = "tab";
            b.setAttribute("role", "tab");
            b.setAttribute("aria-selected", String(t.id === current.id));
            b.textContent = t.tipo_menu;
            b.onclick = async () => {
              current = t;
              await renderPanel();
              renderTabs();
            };
            tabsEl.appendChild(b);
          });
        }

        async function renderPanel() {
          const items = await getItems(current.tipo_menu);
          panelEl.innerHTML = `
        <div class="card">
          <h2>Men√∫ de ${current.tipo_menu}</h2>
          <ul>${items.map((i) => `<li>${i}</li>`).join("")}</ul>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnAceptar">ACEPTAR</button>
          <button class="btn secondary" id="btnCancelar">CANCELAR</button>
        </div>`;
          document
            .getElementById("btnAceptar")
            .addEventListener("click", async () => {
              // generar formulario de confirmaci√≥n
              const items = await getItems(current.tipo_menu);
              const qp = new URLSearchParams(location.search);
              const nombre = qp.get("nombre") || "Comensal";
              const card = qp.get("card") || "0003322164";
              const combined = `${card}${nombre}`; // codigo + nombre todo junto
              // generar ID: PEDDDMMAA-XX
              const d = new Date();
              const dd = String(d.getDate()).padStart(2, "0");
              const mm = String(d.getMonth() + 1).padStart(2, "0");
              const yy = String(d.getFullYear()).slice(-2);
              const dateKey = dd + mm + yy;
              const storeKey = "ped-" + dateKey;
              const last =
                parseInt(localStorage.getItem(storeKey) || "0", 10) + 1;
              localStorage.setItem(storeKey, String(last));
              const seq = String(last).padStart(2, "0");
              const pedidoCode = `PED${dateKey}-${seq}`;
              showConfirm({
                pedidoCode,
                tipo: current.tipo_menu,
                items,
                combined,
                nombre,
                card,
              });
            });
          document
            .getElementById("btnCancelar")
            .addEventListener("click", () => {
              // volver a la pantalla de autenticaci√≥n
              location.href = "auth.html";
            });
        }

        renderTabs();
        await renderPanel();
      })();

      // Confirmation modal (ticket style)
      function showConfirm({
        pedidoCode,
        tipo,
        items,
        combined,
        nombre,
        card,
      }) {
        // remove existing
        const existing = document.getElementById("confirm-overlay");
        if (existing) existing.remove();
        const overlay = document.createElement("div");
        overlay.id = "confirm-overlay";
        overlay.className = "confirm-overlay";
        const box = document.createElement("div");
        box.className = "confirm-box";
        box.innerHTML +=
          '<button class="confirm-close" aria-label="Cerrar">√ó</button>';
        const left = document.createElement("div");
        left.className = "confirm-left";
        const right = document.createElement("div");
        right.className = "confirm-right";

        // ticket wrapper + print button
        left.innerHTML = `
        <div class="ticket-wrap">
          <div id="ticket" class="ticket" aria-label="Comprobante de men√∫"></div>
        </div>`;

        right.innerHTML = `
          <div class="printer-ico lg" aria-hidden="true">üñ®Ô∏è</div>
          <button class="btn-print" id="btnPrintTicket">Imprimir</button>
          <div class="confirm-actions">
            <button class="btn secondary" id="btnCloseConfirm">CANCELAR</button>
          </div>
        `;

        box.appendChild(left);
        box.appendChild(right);
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        // render ticket inside #ticket
        const ticketElem = document.getElementById("ticket");
        const ticketData = {
          ped: pedidoCode,
          tipo: (tipo || "").toUpperCase(),
          items: items || [],
          auth: { code: card, nombre: nombre },
          tabs: buildTabsObject(tipo),
        };
        renderTicket(ticketElem, ticketData);

        // handlers
        function escHandler(ev) {
          if (ev.key === "Escape") close();
        }
        function close() {
          document.body.classList.remove("modal-open");
          overlay.remove();
          document.removeEventListener("keydown", escHandler);
        }
        document
          .getElementById("btnCloseConfirm")
          .addEventListener("click", close);
        const closeBtn = box.querySelector(".confirm-close");
        if (closeBtn) closeBtn.addEventListener("click", close);
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) close();
        });
        document.addEventListener("keydown", escHandler);
        document.body.classList.add("modal-open");
        const printBtn = document.getElementById("btnPrintTicket");
        if (printBtn) {
          printBtn.focus();
          printBtn.addEventListener("click", async () => {
            // impresi√≥n directa v√≠a agente local (Flask + brother_ql)
            try {
              // cargar html2canvas din√°micamente si no est√° presente
              if (typeof html2canvas === "undefined") {
                await new Promise((res, rej) => {
                  const s = document.createElement("script");
                  s.src =
                    "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
                  s.onload = res;
                  s.onerror = rej;
                  document.head.appendChild(s);
                });
              }

              const node = document.getElementById("ticket");
              // reducir scale para generar una imagen m√°s peque√±a y r√°pida de enviar
              const canvas = await html2canvas(node, {
                scale: 1.5,
                backgroundColor: "#FFFFFF",
              });

              // obtener blob en lugar de dataURL para evitar sobrecarga base64
              const blob = await new Promise((resolve) =>
                canvas.toBlob(resolve, "image/png", 0.9)
              );

              const form = new FormData();
              form.append("file", blob, "ticket.png");

              // iniciar la petici√≥n de impresi√≥n pero no bloquear demasiado la UX
              const fetchPromise = fetch("http://127.0.0.1:5001/print", {
                method: "POST",
                body: form,
              })
                .then(async (r) => {
                  try {
                    return await r.json();
                  } catch (e) {
                    return { ok: r.ok };
                  }
                })
                .catch((e) => ({ ok: false, msg: e.message }));

              // esperar a que la petici√≥n termine, pero como m√°ximo timeoutMs ms
              const timeoutMs = 900;
              const winner = await Promise.race([
                fetchPromise,
                new Promise((res) =>
                  setTimeout(() => res({ timeout: true }), timeoutMs)
                ),
              ]);

              if (!winner || winner.timeout) {
                // no esperar m√°s; redirigimos y dejamos que la petici√≥n contin√∫e
                // (mejora la percepci√≥n de velocidad)
              } else if (!winner.ok) {
                alert(
                  "No se pudo imprimir: " +
                    (winner.msg || JSON.stringify(winner))
                );
              }
            } catch (err) {
              console.error(err);
              // ofrecer fallback a impresi√≥n por navegador si el agente local falla
              const shouldFallback = confirm(
                "Error al imprimir directamente: " +
                  (err.message || err) +
                  "\n\n¬øImprimir v√≠a el di√°logo del navegador como fallback?"
              );
              if (shouldFallback) {
                try {
                  window.print();
                } catch (e) {
                  alert(
                    "No se pudo abrir el di√°logo de impresi√≥n: " +
                      (e.message || e)
                  );
                }
              }
            } finally {
              // despu√©s de iniciar impresi√≥n (o timeout), volver a Auth
              setTimeout(() => {
                location.href = "auth.html";
              }, 250);
            }
          });
        }
      }

      // build simple tabs object for checks (mark the matching tipo)
      function buildTabsObject(tipo) {
        const map = {
          DES: "Desayuno",
          ALM: "Almuerzo",
          ESP: "Almuerzo-Especial",
          TE: "Te",
          CEN: "Cena",
          TRAS: "Trasnoche",
        };
        const res = { DES: 0, ALM: 0, ESP: 0, TE: 0, CEN: 0, TRAS: 0 };
        if (!tipo) return res;
        // find key whose value matches tipo (loose)
        for (const k in map) {
          if (map[k].toLowerCase() === tipo.toLowerCase()) res[k] = 1;
        }
        return res;
      }

      // render ticket function (from provided snippet)
      function renderTicket(el, data) {
        const chk = (key, label) => `
        <div class="chk"><span class="box ${
          data.tabs[key] ? "on" : ""
        }"></span><span class="lab">${label}</span></div>`;
        el.innerHTML = `
        <!-- fila superior: PED + TIPO -->
        <div class="t-row t-b">
          <div class="t-col t-code t-r">${data.ped}</div>
          <div class="t-col t-type">${data.tipo}</div>
        </div>
        <!-- contenido: items a la izquierda, checks a la derecha -->
        <div class="t-row t-b">
          <div class="t-col" style="flex:1; padding:0">
            <div class="t-body">
              <div class="t-items">
                <ul>${(data.items || [])
                  .map((x) => `<li>${x}</li>`)
                  .join("")}</ul>
              </div>
              <div class="t-checks">
                ${chk("DES", "DES")}
                ${chk("ALM", "ALM")}
                ${chk("ESP", "ESP")}
                ${chk("TE", "TE")}
                ${chk("CEN", "CEN")}
                ${chk("TRAS", "TRAS")}
              </div>
            </div>
          </div>
        </div>
        <!-- auth -->
        <div class="t-row">
          <div class="t-col t-auth" style="flex:1">
            AUTH: ${data.auth.code} ${data.auth.nombre}
          </div>
        </div>`;
      }
    </script>
  </body>
</html>
