<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Menu - Comedor</title>
    <link rel="stylesheet" href="assets/css/theme.css" />
    <style>
      :root {
        --accent: var(--COLOR-2, #f7e6e3);
      }
      body {
        font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
        padding: 34px;
        background: var(--bg, #fff);
        color: var(--text, #111);
        font-size: 25px;
      }
      .container {
        max-width: 1300px;
        margin: 0 auto;
        padding: 6px 18px;
      }
      .header {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 18px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .header-center {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .header-right {
        text-align: right;
      }
      .tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 14px 0 18px;
        justify-content: flex-start;
      }
      .tab {
        padding: 14px 22px;
        min-width: 140px;
        text-align: center;
        border: 1px solid #f4d8d7;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        background: #fff6f6;
        cursor: pointer;
        font-weight: 800;
        color: #333;
        font-size: 22px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
      }
      .tab[aria-selected="true"] {
        background: #ff6b65; /* strong accent */
        color: #fff;
        border-color: #ff6b65;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
      }
      .panel {
        border: 1px solid #e6e6e6;
        border-radius: 14px;
        padding: 26px;
        background: #fff;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.05);
      }
      .panel .card {
        background: var(--accent);
        border-radius: 14px;
        padding: 26px;
        margin: 8px 0 18px;
        font-size: 18px;
      }
      .panel h2 {
        margin: 0 0 12px;
        font-size: 22px;
      }
      .panel ul {
        margin: 0 0 8px 20px;
        line-height: 1.6;
      }
      .panel .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 18px;
      }
      .btn {
        padding: 12px 18px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: var(--accent, #ff6b65);
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      }
      .btn.primary {
        background: #ff6b65;
        color: #fff;
        border-color: #ff6b65;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      }
      .btn.secondary {
        background: #fff;
        color: #111;
        border: 1px solid #eee;
        box-shadow: none;
      }
      .no-menus {
        padding: 18px;
        border: 1px dashed #e6e6e6;
        border-radius: 12px;
        background: #fff;
        color: #666;
      }
      /* confirm modal */
      .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:1200}
      .confirm-box{background:#fff;border-radius:10px;padding:22px;max-width:900px;width:92%;box-shadow:0 18px 60px rgba(0,0,0,0.35);display:flex;gap:24px;align-items:flex-start}
      .confirm-left{flex:1}
      .receipt{border:1px solid #e6e6e6;padding:16px;border-radius:8px;background:#fff}
      .receipt h3{margin:0 0 8px;font-size:20px}
      .receipt .code{font-weight:900;font-size:20px;margin-bottom:8px}
      .receipt ul{margin:8px 0 12px 18px}
      .receipt .auth{margin-top:10px;font-weight:700}
      .confirm-right{width:220px;display:flex;flex-direction:column;align-items:center;gap:18px}
      .confirm-actions{display:flex;gap:12px;justify-content:center;margin-top:12px}
      .printer-ico{width:120px;height:120px;border-radius:10px;border:1px dashed #eee;display:flex;align-items:center;justify-content:center}
      @media (max-width: 900px) {
        .container {
          padding: 12px;
        }
      }
      @media (max-width: 720px) {
        .tabs {
          gap: 6px;
        }
        .tab {
          padding: 8px 10px;
          font-size: 20px;
          min-width: 80px;
        }
        .btn {
          padding: 10px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-left">
          <div
            id="usuario"
            class="user"
            style="
              font-weight: 700;
              color: #333;
              font-size: 18px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <span id="usuario-icon">üë§</span>
            <span id="usuario-text">Comensal (0003322164)</span>
          </div>
        </div>
        <div class="header-center">
          <img
            src="assets/images/logo-dekma.png"
            alt="Dekma"
            style="height: 44px"
            onerror="this.style.display='none'"
          />
          <strong style="font-size: 34px; letter-spacing: 2px; margin-top: 6px"
            >MENU</strong
          >
        </div>
        <div class="header-right">
          <div id="fecha">&nbsp;</div>
        </div>
      </div>

      <div id="menuRoot">
        <div
          class="tabs"
          id="tabs"
          role="tablist"
          aria-label="Men√∫ del d√≠a"
        ></div>
        <div class="panel" id="panel" role="tabpanel" tabindex="0"></div>
      </div>
    </div>

    <script>
      // Mock data fallback (tabs requested by user)
      const mockTabs = [
        { id: 1, tipo_menu: "Desayuno", estado: 1 },
        { id: 2, tipo_menu: "Almuerzo", estado: 1 },
        { id: 3, tipo_menu: "Almuerzo-Especial", estado: 1 },
        { id: 4, tipo_menu: "Te", estado: 1 },
        { id: 5, tipo_menu: "Cena", estado: 1 },
        { id: 6, tipo_menu: "Trasnoche", estado: 1 },
      ];
      const mockItems = {
        Desayuno: ["Api de quinua", "Tostadas con queso", "T√© con hierbas"],
        Almuerzo: ["Sopa de man√≠", "Pique macho", "Refresco de linaza"],
        "Almuerzo-Especial": [
          "Ensalada templada",
          "Segunda opci√≥n: pollo",
          "Jugo natural",
        ],
        Te: ["Bizcocho", "Mermelada", "T√© negro"],
        Cena: ["Caldito de pollo", "Arroz con queso", "Mate de manzanilla"],
        Trasnoche: ["Bebida caliente", "Tostadas", "Sopa ligera"],
      };

      async function getTabs() {
        try {
          const r = await fetch("/api/menu/tabs");
          if (r.ok) return r.json();
        } catch (e) {}
        return mockTabs;
      }

      async function getItems(tipo) {
        try {
          const r = await fetch(
            "/api/menu/items?tipo=" + encodeURIComponent(tipo)
          );
          if (r.ok) return r.json();
        } catch (e) {}
        return mockItems[tipo] || [];
      }

      document.getElementById("fecha").textContent =
        new Date().toLocaleDateString();
      // fecha estilo m√°s grande
      const f = document.getElementById("fecha");
      if (f) {
        f.style.fontSize = "25px";
        f.style.fontWeight = "700";
      }

      // populate user from querystring (optional)
      (function populateUser() {
        try {
          const qp = new URLSearchParams(location.search);
          const nombre = qp.get("nombre") || "Comensal";
          const card = qp.get("card") || "0003322164";
          const tipo = qp.get("tipo") || "";
          const uText = document.getElementById("usuario-text");
          const uIcon = document.getElementById("usuario-icon");
          if (uText)
            uText.textContent = `${nombre}${card ? ` (${card})` : ""}${
              tipo ? ` ‚Äì ${tipo}` : ""
            }`;
          if (uIcon) uIcon.textContent = "üë§";
        } catch (e) {
          /* ignore */
        }
      })();

      (async function init() {
        const raw = await getTabs();
        const tabsData = (raw || [])
          .filter((t) => Number(t.estado) === 1)
          .sort((a, b) => a.id - b.id);
        const tabsEl = document.getElementById("tabs");
        const panelEl = document.getElementById("panel");
        if (!tabsData || tabsData.length === 0) {
          tabsEl.innerHTML = "";
          panelEl.innerHTML =
            '<div class="no-menus">No hay men√∫s habilitados hoy.</div>';
          return;
        }
        let current = tabsData[0];

        function renderTabs() {
          tabsEl.innerHTML = "";
          tabsData.forEach((t) => {
            const b = document.createElement("button");
            b.className = "tab";
            b.setAttribute("role", "tab");
            b.setAttribute("aria-selected", String(t.id === current.id));
            b.textContent = t.tipo_menu;
            b.onclick = async () => {
              current = t;
              await renderPanel();
              renderTabs();
            };
            tabsEl.appendChild(b);
          });
        }

        async function renderPanel() {
          const items = await getItems(current.tipo_menu);
          panelEl.innerHTML = `
        <div class="card">
          <h2>Men√∫ de ${current.tipo_menu}</h2>
          <ul>${items.map((i) => `<li>${i}</li>`).join("")}</ul>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnAceptar">ACEPTAR</button>
          <button class="btn secondary" id="btnCancelar">CANCELAR</button>
        </div>`;
          document
            .getElementById("btnAceptar")
            .addEventListener("click", async () => {
              // generar formulario de confirmaci√≥n
              const items = await getItems(current.tipo_menu);
              const qp = new URLSearchParams(location.search);
              const nombre = qp.get("nombre") || "Comensal";
              const card = qp.get("card") || "0003322164";
              const combined = `${card}${nombre}`; // codigo + nombre todo junto
              // generar ID: PEDDDMMAA-XX
              const d = new Date();
              const dd = String(d.getDate()).padStart(2,'0');
              const mm = String(d.getMonth()+1).padStart(2,'0');
              const yy = String(d.getFullYear()).slice(-2);
              const dateKey = dd+mm+yy;
              const storeKey = 'ped-'+dateKey;
              const last = parseInt(localStorage.getItem(storeKey)||'0',10) + 1;
              localStorage.setItem(storeKey, String(last));
              const seq = String(last).padStart(2,'0');
              const pedidoCode = `PED${dateKey}-${seq}`;
              showConfirm({ pedidoCode, tipo: current.tipo_menu, items, combined, nombre, card });
            });
          document
            .getElementById("btnCancelar")
            .addEventListener("click", () => {
              // volver a la pantalla de autenticaci√≥n
              location.href = "auth.html";
            });
        }

        renderTabs();
        await renderPanel();
      })();
  
      // Confirmation modal
      function showConfirm({pedidoCode, tipo, items, combined, nombre, card}){
        // remove existing
        const existing = document.getElementById('confirm-overlay'); if(existing) existing.remove();
        const overlay = document.createElement('div'); overlay.id='confirm-overlay'; overlay.className='confirm-overlay';
        const box = document.createElement('div'); box.className='confirm-box';
        const left = document.createElement('div'); left.className='confirm-left';
        const right = document.createElement('div'); right.className='confirm-right';

        left.innerHTML = `<div class="receipt">
            <h3>CONFIRMAR PEDIDO</h3>
            <div class="code">${pedidoCode}</div>
            <div style="font-weight:700;margin-bottom:6px">${tipo}</div>
            <div>
              <ul>${(items||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
            </div>
            <div class="auth">COD: ${combined}</div>
            <div class="auth">AUTH: ${combined}</div>
          </div>`;

        right.innerHTML = `<div class="printer-ico">üñ®Ô∏è</div>
          <div class="confirm-actions">
            <button class="btn primary" id="btnPrintNow">IMPRIMIR</button>
            <button class="btn secondary" id="btnCloseConfirm">CANCELAR</button>
          </div>`;

        box.appendChild(left); box.appendChild(right); overlay.appendChild(box); document.body.appendChild(overlay);

        document.getElementById('btnCloseConfirm').addEventListener('click', ()=> location.href='auth.html');
        document.getElementById('btnPrintNow').addEventListener('click', ()=>{
          // print the page (user asked imprimir does not navigate)
          window.print();
        });
      }
    </script>
  </body>
</html>
