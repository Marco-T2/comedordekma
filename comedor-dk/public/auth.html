<!DOCTYPE html><meta charset="utf-8" />
<title>Autenticación</title>
<style>
  body {
    font: 22px/1.4 system-ui, Arial;
    display: grid;
    place-items: center;
    height: 100dvh;
    margin: 0;
    background: #111;
    color: #eee;
  }
  .card {
    background: #1b1b1b;
    padding: 32px 28px;
    border-radius: 14px;
    min-width: 420px;
    text-align: center;
    box-shadow: 0 10px 30px #0007;
  }
  .ok {
    color: #7cfc00;
  }
  .err {
    color: #ff6b6b;
  }
</style>
<h1
  style="
    position: fixed;
    top: 16px;
    left: 16px;
    font: 14px monospace;
    color: #888;
  "
>
  auth
</h1>
<div class="card">
  <div id="estado">Pase su tarjeta…</div>
  <div id="sub" style="font: 14px monospace; color: #888; margin-top: 8px">
    Esperando evento RFID
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const estado = document.getElementById("estado");
  const sub = document.getElementById("sub");
  const socket = io(); // mismo host/puerto que sirvió esta página
  let lastTs = 0;

  socket.on("connect", () => (sub.textContent = "Conectado"));
  socket.on("connect_error", (e) => (sub.textContent = "Error: " + e.message));

  // Compatibilidad con el evento viejo (por si tu server aún emite rfid-scan)
  socket.on("rfid-scan", (e) => handleEvent({ type: "rfid", ...e }));

  // Nuevo evento unificado
  socket.on("access-event", handleEvent);

  function handleEvent(e) {
    // anti-doble: evita repetir el mismo evento
    if (e.ts && e.ts === lastTs) return;
    lastTs = e.ts || Date.now();

    const r = e.result || {};
    const idTxt = e.code ?? e.cardId ?? ""; // RFID usa code, huella usa cardId
    const origen = e.type === "finger" ? "huella" : "rfid";

    if (r.ok) {
      estado.innerHTML = `✅ <span class="ok">(${origen}) Hola ${r.nombre}</span><br><small>(${idTxt})</small>`;
      // redirige al menú con datos por querystring
      const q = new URLSearchParams({
        nombre: r.nombre || "",
        card: idTxt || "",
        tipo: r.tipo || "",
        origen,
      });
      setTimeout(() => (location.href = "/menu.html?" + q.toString()), 900);
    } else {
      estado.innerHTML = `❌ <span class="err">(${origen}) ${
        r.msg || "No válido"
      }</span>`;
      setTimeout(
        () => (estado.textContent = "Pase su tarjeta o huella…"),
        1200
      );
    }
  }
</script>
