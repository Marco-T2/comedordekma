<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="light" />
    <style>
      :root {
        color-scheme: light;
      }
    </style>
    <title>Autenticación - Comedor</title>
    <link rel="stylesheet" href="assets/css/theme.css" />
    <style>
      /* Light theme: fondo blanco, texto negro */
      :root {
        --bg: #ffffff;
        --text: #111111;
        --muted: #6b6b6b;
        --accent: var(--COLOR-2, #f7e6e3);
      }
      html,
      body {
        height: 100%;
        background: var(--bg);
        color: var(--text);
        font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
        font-size: 20px;
      }
      .auth-wrap {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 24px 18px 24px;
      }
      header .brand {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      header .brand h1 {
        margin: 6px 0;
        font-size: 54px;
        letter-spacing: 4px;
      }
      .content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 40px;
        align-items: center;
        width: 100%;
        max-width: 1100px;
      }
      .left {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .reader-svg {
        width: 340px;
        height: 340px;
        max-width: 90%;
      }
      .fields {
        width: 100%;
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-bottom: 18px;
      }
      .field {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .field label {
        font-weight: 800;
        color: #444;
        font-size: 18px;
      }
      .field input {
        padding: 16px 18px;
        border-radius: 10px;
        border: 1px solid #e6e6e6;
        background: #fff;
        color: var(--text);
        width: 440px;
        font-size: 20px;
      }
      .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 8px;
      }
      .key {
        background: #ffffff;
        border: 1px solid #e6e6e6;
        border-radius: 14px;
        padding: 26px;
        font-size: 32px;
        color: #111;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.04);
      }
      .key.action {
        background: var(--accent);
        color: #111;
        font-weight: 800;
      }
      .touch-btn {
        margin-top: 22px;
        background: var(--accent);
        border-radius: 50%;
        width: 68px;
        height: 68px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        cursor: pointer;
      }
      /* touch image-only variant */
      .touch-img {
        width: 96px;
        height: 96px;
        object-fit: contain;
        cursor: pointer;
        background: transparent;
        border-radius: 10px;
      }
      .date {
        color: #555;
        font-weight: 800;
        font-size: 20px;
      }

      /* left header label (AUTENTIFICACION) styling */
      .left-h .muted {
        font-weight: 800;
        font-size: 18px;
        margin-top: -6px;
        color: #444;
      }
      /* overlay when card read */
      #cardOverlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.9);
        z-index: 60;
        backdrop-filter: blur(4px);
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.25s ease, visibility 0.25s;
      }
      #cardOverlay.show {
        visibility: visible;
        opacity: 1;
      }
      .overlay-card {
        background: #fff;
        border-radius: 12px;
        padding: 32px 36px;
        box-shadow: 0 14px 50px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        min-width: 320px;
      }
      .overlay-name {
        font-size: 26px;
        font-weight: 800;
      }
      .overlay-code {
        font-size: 28px;
        color: var(--muted);
        font-weight: 800;
        letter-spacing: 2px;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
          max-width: 720px;
        }
        .field input {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="auth-wrap">
      <header>
        <div class="left-h">
          <div class="muted">AUTENTIFICACION</div>
        </div>
        <div class="brand">
          <img
            src="assets/images/logo-dekma.png"
            alt="DEKMA"
            style="height: 64px; display: block; object-fit: contain"
            onerror="this.style.display='none'"
          />
          <h1>COMEDOR</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 10px">
          <div class="date" id="fecha"></div>
          <!-- Enlace administrativo simplificado -->
          <a
            id="adminLink"
            href="listarCard.html"
            style="
              font-size: 14px;
              color: #0b63ff;
              text-decoration: none;
              padding: 6px 10px;
              border-radius: 8px;
              border: 1px solid #e6e6e6;
              background: #fff;
            "
            >Administración</a
          >
        </div>
      </header>

      <main class="content">
        <div class="grid">
          <div class="left">
            <div class="fields">
              <div class="field">
                <label for="code">CODIGO</label>
                <input id="code" placeholder="------" readonly />
              </div>
              <div class="field">
                <label for="name">NOMBRE</label>
                <input id="name" placeholder="Nombre completo" />
              </div>
            </div>

            <!-- Card reader illustration (PNG icon replaces inline SVG) -->
            <img
              class="reader-svg"
              src="assets/images/iconLector.png"
              alt="Lector de tarjetas"
            />

            <div style="margin-top: 12px">Pase la tarjeta sobre el lector</div>
          </div>

          <div>
            <div
              style="
                display: flex;
                justify-content: center;
                margin-bottom: 18px;
              "
            >
              <div style="width: 320px">
                <div class="keypad" id="keypad">
                  <!-- buttons generated by JS -->
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: center">
              <!-- touch as image only -->
              <img
                id="touchBtn"
                class="touch-img"
                src="assets/images/IconTouch.png"
                alt="Touch"
                title="Touch / Confirm"
                aria-hidden="true"
              />
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Overlay shown when a card is read; waits ~3s showing user's name and code -->
    <div id="cardOverlay" aria-hidden="true">
      <div class="overlay-card">
        <div
          style="
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: var(--accent);
          "
        ></div>
        <div class="overlay-name" id="overlayName">Comensal</div>
        <div class="overlay-code" id="overlayCode">0000000000</div>
      </div>
    </div>

    <script>
      // socket.io client - listen for access events from the realtime bridge
      (function () {
        const s = document.createElement("script");
        s.src = "/socket.io/socket.io.js";
        s.onload = () => {
          try {
            const socket = io();
            socket.on("connect", () => console.debug("socket connected"));
            socket.on("access-event", (ev) => {
              // ev: { type, code, cardId, result }
              const code = ev.code || ev.cardId || ev.card || "";
              const name =
                ev.result &&
                (ev.result.nombre || ev.result.name || ev.result.nameFull)
                  ? ev.result.nombre || ev.result.name || ev.result.nameFull
                  : null;
              // call receiveCard with optional name to show immediately
              receiveCard(code, name, ev.type);
            });
          } catch (err) {
            console.debug("socket init failed", err);
          }
        };
        document.head.appendChild(s);
      })();

      // date
      document.getElementById("fecha").textContent =
        new Date().toLocaleDateString();

      // keypad
      const keys = [
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "C",
        "0",
        "OK",
      ];
      const keypad = document.getElementById("keypad");
      keys.forEach((k) => {
        const btn = document.createElement("button");
        btn.className = "key" + (k === "C" || k === "OK" ? " action" : "");
        btn.textContent = k;
        btn.addEventListener("click", () => onKey(k));
        keypad.appendChild(btn);
      });

      function onKey(k) {
        const codeEl = document.getElementById("code");
        if (k === "C") {
          codeEl.value = "";
          return;
        }
        if (k === "OK") {
          submit();
          return;
        }
        codeEl.value = (codeEl.value || "") + k;
      }

      // touch button simulates submit
      document.getElementById("touchBtn").addEventListener("click", submit);

      async function submit() {
        const code = document.getElementById("code").value;
        const nameField = document.getElementById("name");
        const name = nameField.value || "Comensal";
        if (!code) {
          alert("Ingrese código o pase la tarjeta");
          return;
        }

        // Treat OK like a card read: send to bridge (/rfid) so server validates and emits
        try {
          // show overlay immediately (masking code) with submitted name
          receiveCard(code, name, "keypad");

          await fetch("/rfid", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code, readerId: "web-keypad", name }),
          });

          // server will emit an access-event (socket) with authoritative result
          // we already showed a provisional overlay above
        } catch (err) {
          alert("Error de red al enviar");
        }
        return;
      }

      // Simulate card read from agent: listen to storage event (optional integration)
      window.addEventListener("storage", (e) => {
        if (e.key === "rfid_code") {
          receiveCard(e.newValue);
        }
      });

      // Receive a card code (from agent or other integration). Shows overlay with name/code for 3s.
      async function receiveCard(code, initialName = null, origin = null) {
        if (!code) return;
        // show overlay
        const overlay = document.getElementById("cardOverlay");
        const nameEl = document.getElementById("overlayName");
        const codeEl = document.getElementById("overlayCode");
        nameEl.textContent = "Cargando...";
        // mask code for privacy (show first 3 chars then two asterisks when length>3)
        function mask(c) {
          if (!c) return "";
          if (c.length <= 3) return c;
          return c.slice(0, 3) + "**";
        }
        codeEl.textContent = mask(code);
        if (initialName) nameEl.textContent = initialName;
        overlay.classList.add("show");

        // Try to fetch user info from backend using the validar endpoint
        // which accepts physical card codes or assigned 5-digit codes.
        if (!initialName) {
          try {
            const res = await fetch(`/api/validar/${encodeURIComponent(code)}`);
            if (res.ok) {
              const data = await res.json();
              // API returns { ok:true, nombre, card, code_rfc, tipo }
              nameEl.textContent = data.nombre || data.name || "Comensal";
              // update overlay code to show masked version of whichever code we have
              codeEl.textContent = mask(
                data.card || data.code || data.code_rfc || code
              );
            } else {
              nameEl.textContent = "Comensal";
            }
          } catch (err) {
            // network or not available
            nameEl.textContent = "Comensal";
          }
        }

        // wait ~3s to mimic verification
        await new Promise((r) => setTimeout(r, 3000));
        overlay.classList.remove("show");

        // fill fields with obtained info
        document.getElementById("code").value = code;
        document.getElementById("name").value = nameEl.textContent || "";

        // auto-redirect: after overlay hides, go to menu with obtained info
        // small delay to allow overlay hide animation to complete
        setTimeout(() => {
          const name = document.getElementById("name").value || "";
          const card = document.getElementById("code").value || code || "";
          const url = `/menu.html?nombre=${encodeURIComponent(
            name
          )}&card=${encodeURIComponent(card)}`;
          location.href = url;
        }, 200);
      }

      // Expose a helper to simulate a card read from console
      window.__simulateCard = (c) => {
        localStorage.setItem("rfid_code", c);
        localStorage.removeItem("rfid_code");
      };
    </script>
  </body>
</html>
