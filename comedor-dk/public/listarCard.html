<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Listado de Tarjetas - Comedor</title>
    <link rel="stylesheet" href="assets/css/theme.css" />
    <style>
      body {
        font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
        padding: 20px;
        background: #fff;
        color: #111;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 18px;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .logo img {
        height: 36px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 28px;
      }
      .meta {
        color: #666;
        font-weight: 600;
      }

      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin: 12px 0;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      .btn.primary {
        background: #ff6b65;
        color: #fff;
      }
      .btn.ghost {
        background: #fff;
        border: 1px solid #eee;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid #eee;
      }
      th {
        background: #fafafa;
        font-weight: 800;
      }
      td.actions {
        display: flex;
        gap: 8px;
      }
      .mask {
        font-family: monospace;
      }

      .empty {
        padding: 22px;
        border: 1px dashed #eee;
        border-radius: 10px;
        color: #666;
      }

      @media (max-width: 800px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        td.actions {
          gap: 6px;
          margin-top: 8px;
        }
        th {
          display: none;
        }
        td {
          border: none;
          padding: 8px 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo">
          <img
            src="assets/images/logo-dekma.png"
            alt="Dekma"
            onerror="this.style.display='none'"
          />
          <div>
            <div style="font-weight: 700">Panel de administración</div>
            <div class="meta">Tarjetas / Usuarios</div>
          </div>
        </div>
        <div class="meta" id="fecha">&nbsp;</div>
      </header>

      <div class="toolbar">
        <div>
          <button class="btn primary" id="btnNew">Crear tarjeta</button>
        </div>
        <div style="color: #666">Listado de tarjetas registradas</div>
      </div>

      <div id="listArea">
        <div class="empty">Cargando tarjetas…</div>
      </div>
    </div>

    <script>
      document.getElementById("fecha").textContent =
        new Date().toLocaleDateString();
      document
        .getElementById("btnNew")
        .addEventListener(
          "click",
          () => (location.href = "registrarCard.html")
        );

      function maskCode(s) {
        if (!s) return "";
        try {
          s = String(s);
          return s.length > 3 ? s.slice(0, 3) + "**" : s;
        } catch (e) {
          return s;
        }
      }

      async function loadCards() {
        const area = document.getElementById("listArea");
        try {
          const r = await fetch("/api/cards");
          if (!r.ok) throw new Error("HTTP " + r.status);
          const data = await r.json();
          if (!Array.isArray(data) || data.length === 0) {
            area.innerHTML =
              '<div class="empty">No hay tarjetas registradas.</div>';
            return;
          }

          const table = document.createElement("table");
          table.innerHTML = `
            <thead><tr><th>Nombre</th><th>Tipo</th><th>Code</th><th>Code RFC</th><th>Activo</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          `;
          const tbody = table.querySelector("tbody");
          data.forEach((c) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(c.nombre || "")}</td>
              <td>${escapeHtml(c.tipo || "")}</td>
              <td class="mask">${escapeHtml(
                maskCode(c.code || c.code_rfc || "")
              )}</td>
              <td>${escapeHtml(c.code_rfc || "")}</td>
              <td>${c.activo == 1 ? "Sí" : "No"}</td>
              <td class="actions">
                <button class="btn ghost" data-id="${
                  c.id
                }" data-action="edit">Editar</button>
                <button class="btn" style="background:#ff6b65;color:#fff" data-id="${
                  c.id
                }" data-action="del">Eliminar</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          area.innerHTML = "";
          area.appendChild(table);

          // hook actions
          area.querySelectorAll("button[data-action]").forEach((b) => {
            b.addEventListener("click", async (ev) => {
              const id = b.getAttribute("data-id");
              const act = b.getAttribute("data-action");
              if (act === "edit") {
                location.href =
                  "registrarCard.html?id=" + encodeURIComponent(id);
                return;
              }
              if (act === "del") {
                if (
                  !confirm(
                    "¿Eliminar tarjeta? Esto marcará como inactiva la tarjeta."
                  )
                )
                  return;
                try {
                  const res = await fetch("/api/cards/" + id, {
                    method: "DELETE",
                  });
                  if (!res.ok) throw new Error("Error " + res.status);
                  // remove row
                  b.closest("tr").remove();
                } catch (err) {
                  alert("No se pudo eliminar: " + err.message);
                }
              }
            });
          });
        } catch (err) {
          area.innerHTML =
            '<div class="empty">Error cargando tarjetas: ' +
            escapeHtml(String(err.message || err)) +
            "</div>";
        }
      }

      // small escape helper
      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function (m) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m];
        });
      }

      // initial load
      loadCards();
    </script>
  </body>
</html>
